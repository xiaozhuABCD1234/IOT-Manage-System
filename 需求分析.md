# 智慧监理需求分析

## 前端（适配手机端）

### 用户模块

| 角色       | 功能权限                                                                         |
| ---------- | -------------------------------------------------------------------------------- |
| 系统管理员 | 管理电子标记、普通用户；查看定位地图、危险报警、电子标记状态、服务器负载以及状态 |
| 普通用户   | 查看定位地图、危险报警                                                           |

### 功能需求

1. 使用用户名+密码登录 (jwt) 用户管理
2. 增删改查电子标记
3. 查看各个电子标记连接服务器状态
4. 查看服务器状态
5. 手动绘制电子围栏
6. 根据电子围栏，以及危险标记半径提示警报
7. 查看实时定位地图和历史定位地图

### 页面清单

| 序号 | 页面名称     | 访问角色        | 主要功能/说明                                                            |
| ---- | ------------ | --------------- | ------------------------------------------------------------------------ |
| 1    | 登录页       | 所有用户        | 用户名+密码登录（JWT），自动跳转对应首页                                 |
| 2    | 实时监控大屏 | 管理员/普通用户 | 实时定位地图、危险报警弹窗、全局报警统计卡片                             |
| 3    | 电子标记管理 | 仅管理员        | 列表分页、新增/编辑/删除/批量导入、标记在线/离线状态、信号强度、电量显示 |
| 4    | 用户管理     | 仅管理员        | 新增/编辑/删除/重置密码普通用户、角色分配、操作日志                      |
| 5    | 服务器监控   | 仅管理员        | CPU、内存、磁盘、网络实时曲线；服务进程启停；异常告警推送设置            |
| 6    | 电子围栏配置 | 管理员          | 手动绘制多边形/圆形围栏、围栏颜色/名称设置、绑定危险半径、一键启用/禁用  |
| 7    | 报警中心     | 管理员/普通用户 | 实时报警列表、报警声音/弹窗开关、历史报警查询与导出、报警处理记录        |
| 8    | 历史轨迹回放 | 管理员/普通用户 | 选择标记+时间段，轨迹动画回放、倍速控制、轨迹点列表、轨迹导出（CSV）     |
| 9    | 个人中心     | 所有用户        | 修改密码、查看个人权限、消息订阅设置、退出登录                           |
| 10   | 系统设置     | 仅管理员        | 地图底图切换、报警阈值配置、日志清理策略、备份与恢复                     |

## 后端

### 概述

后端采用gin/FastAPI+postgreSQL微服务架构，分为gateway、user-service、mqtt-saver、websocket-service、mark-service、map-service

### 服务总览

| 服务              | 端口 | 协议/备注                 | 职责说明                                                   |
| ----------------- | ---- | ------------------------- | ---------------------------------------------------------- |
| gateway           | 8000 | HTTP                      | 统一网关：鉴权、限流、路由、熔断                           |
| user-service      | 8001 | HTTP                      | 用户/角色/权限、JWT                                        |
| mqtt-saver        | 8002 | WebSocket 8083            | 订阅 MQTT → 解析 → 写库/推流                               |
| websocket-service | 8003 | WebSocket 8083            | WebSocket 长连接：实时定位 & 报警推送                      |
| mark-service      | 8004 | HTTP                      | 电子标记 CRUD、在线状态、电量/信号统计                     |
| map-service       | 8005 | HTTP                      | 电子围栏、地理计算、报警判定、历史轨迹存储、查询、导出 CSV |
| **mosquitto**     | 1883 | MQTT/TCP（明文）          | MQTT Broker（设备上行/指令下行）                           |
|                   | 8883 | MQTT/TLS（未来启用）      | TLS 加密通道                                               |
|                   | 8083 | WebSocket（明文）         | 浏览器/前端实时通信                                        |
|                   | 8084 | WebSocket/TLS（未来启用） | 浏览器 TLS 加密通道                                        |
| **PostgreSQL**    | 5432 | TCP                       | 统一持久化：用户、设备、轨迹、围栏、报警等数据存储         |

### 数据模型
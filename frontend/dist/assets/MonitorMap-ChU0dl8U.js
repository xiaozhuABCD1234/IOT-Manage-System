import{l as k,d as C,b,f as x,m as q,c as j,g as S,o as D,_ as E}from"./index-DkkrOWQ5.js";import{m as J}from"./mqtt.esm-BKeQ4ejO.js";import{u as O}from"./config-DlXkem2Y.js";var I={exports:{}},B=I.exports,U;function R(){return U||(U=1,function(l,r){(function(d,f){l.exports=f()})(B,function(){function d(n){var t=[];return n.AMapUI&&t.push(f(n.AMapUI)),n.Loca&&t.push(A(n.Loca)),Promise.all(t)}function f(n){return new Promise(function(t,o){var i=[];if(n.plugins)for(var u=0;u<n.plugins.length;u+=1)a.AMapUI.plugins.indexOf(n.plugins[u])==-1&&i.push(n.plugins[u]);if(s.AMapUI===e.failed)o("前次请求 AMapUI 失败");else if(s.AMapUI===e.notload){s.AMapUI=e.loading,a.AMapUI.version=n.version||a.AMapUI.version,u=a.AMapUI.version;var v=document.body||document.head,h=document.createElement("script");h.type="text/javascript",h.src="https://webapi.amap.com/ui/"+u+"/main.js",h.onerror=function(c){s.AMapUI=e.failed,o("请求 AMapUI 失败")},h.onload=function(){if(s.AMapUI=e.loaded,i.length)window.AMapUI.loadUI(i,function(){for(var c=0,m=i.length;c<m;c++){var w=i[c].split("/").slice(-1)[0];window.AMapUI[w]=arguments[c]}for(t();M.AMapUI.length;)M.AMapUI.splice(0,1)[0]()});else for(t();M.AMapUI.length;)M.AMapUI.splice(0,1)[0]()},v.appendChild(h)}else s.AMapUI===e.loaded?n.version&&n.version!==a.AMapUI.version?o("不允许多个版本 AMapUI 混用"):i.length?window.AMapUI.loadUI(i,function(){for(var c=0,m=i.length;c<m;c++){var w=i[c].split("/").slice(-1)[0];window.AMapUI[w]=arguments[c]}t()}):t():n.version&&n.version!==a.AMapUI.version?o("不允许多个版本 AMapUI 混用"):M.AMapUI.push(function(c){c?o(c):i.length?window.AMapUI.loadUI(i,function(){for(var m=0,w=i.length;m<w;m++){var _=i[m].split("/").slice(-1)[0];window.AMapUI[_]=arguments[m]}t()}):t()})})}function A(n){return new Promise(function(t,o){if(s.Loca===e.failed)o("前次请求 Loca 失败");else if(s.Loca===e.notload){s.Loca=e.loading,a.Loca.version=n.version||a.Loca.version;var i=a.Loca.version,u=a.AMap.version.startsWith("2"),v=i.startsWith("2");if(u&&!v||!u&&v)o("JSAPI 与 Loca 版本不对应！！");else{u=a.key,v=document.body||document.head;var h=document.createElement("script");h.type="text/javascript",h.src="https://webapi.amap.com/loca?v="+i+"&key="+u,h.onerror=function(c){s.Loca=e.failed,o("请求 AMapUI 失败")},h.onload=function(){for(s.Loca=e.loaded,t();M.Loca.length;)M.Loca.splice(0,1)[0]()},v.appendChild(h)}}else s.Loca===e.loaded?n.version&&n.version!==a.Loca.version?o("不允许多个版本 Loca 混用"):t():n.version&&n.version!==a.Loca.version?o("不允许多个版本 Loca 混用"):M.Loca.push(function(c){c?o(c):o()})})}if(!window)throw Error("AMap JSAPI can only be used in Browser.");var e;(function(n){n.notload="notload",n.loading="loading",n.loaded="loaded",n.failed="failed"})(e||(e={}));var a={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},s={AMap:e.notload,AMapUI:e.notload,Loca:e.notload},M={AMapUI:[],Loca:[]},g=[],p=function(n){typeof n=="function"&&(s.AMap===e.loaded?n(window.AMap):g.push(n))};return{load:function(n){return new Promise(function(t,o){if(s.AMap==e.failed)o("");else if(s.AMap==e.notload){var i=n.key,u=n.version,v=n.plugins;i?(window.AMap&&location.host!=="lbs.amap.com"&&o("禁止多种API加载方式混用"),a.key=i,a.AMap.version=u||a.AMap.version,a.AMap.plugins=v||a.AMap.plugins,s.AMap=e.loading,u=document.body||document.head,window.___onAPILoaded=function(c){if(delete window.___onAPILoaded,c)s.AMap=e.failed,o(c);else for(s.AMap=e.loaded,d(n).then(function(){t(window.AMap)}).catch(o);g.length;)g.splice(0,1)[0]()},v=document.createElement("script"),v.type="text/javascript",v.src="https://webapi.amap.com/maps?callback=___onAPILoaded&v="+a.AMap.version+"&key="+i+"&plugin="+a.AMap.plugins.join(","),v.onerror=function(c){s.AMap=e.failed,o(c)},u.appendChild(v)):o("请填写key")}else if(s.AMap==e.loaded)if(n.key&&n.key!==a.key)o("多个不一致的 key");else if(n.version&&n.version!==a.AMap.version)o("不允许多个版本 JSAPI 混用");else{if(i=[],n.plugins)for(u=0;u<n.plugins.length;u+=1)a.AMap.plugins.indexOf(n.plugins[u])==-1&&i.push(n.plugins[u]);i.length?window.AMap.plugin(i,function(){d(n).then(function(){t(window.AMap)}).catch(o)}):d(n).then(function(){t(window.AMap)}).catch(o)}else if(n.key&&n.key!==a.key)o("多个不一致的 key");else if(n.version&&n.version!==a.AMap.version)o("不允许多个版本 JSAPI 混用");else{var h=[];if(n.plugins)for(u=0;u<n.plugins.length;u+=1)a.AMap.plugins.indexOf(n.plugins[u])==-1&&h.push(n.plugins[u]);p(function(){h.length?window.AMap.plugin(h,function(){d(n).then(function(){t(window.AMap)}).catch(o)}):d(n).then(function(){t(window.AMap)}).catch(o)})}})},reset:function(){delete window.AMap,delete window.AMapUI,delete window.Loca,a={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},s={AMap:e.notload,AMapUI:e.notload,Loca:e.notload},M={AMap:[],AMapUI:[],Loca:[]}}}})}(I)),I.exports}var N=R();const T=k(N);class y{constructor(r,d){this.lat=r,this.lng=d}}const L=6378137;function W(l,r){return r<72.004||r>137.8347||l<.8293||l>55.8271}function $(l,r){const d=l*r,f=Math.sqrt(Math.abs(l)),A=l*Math.PI,e=r*Math.PI;let a=20*Math.sin(6*A)+20*Math.sin(2*A),s=a,M=a;return s+=20*Math.sin(e)+40*Math.sin(e/3),M+=20*Math.sin(A)+40*Math.sin(A/3),s+=160*Math.sin(e/12)+320*Math.sin(e/30),M+=150*Math.sin(A/12)+300*Math.sin(A/30),s*=2/3,M*=2/3,s+=-100+2*l+3*r+.2*r*r+.1*d+.2*f,M+=300+l+2*r+.1*l*l+.1*d+.1*f,new y(s,M)}function F(l,r){const d=.006693421622965943,f=$(r-105,l-35),A=l/180*Math.PI,e=Math.sin(A),a=Math.sqrt(1-d*e*e),s=f.lat*180/(L*(1-d)/(e*a)*Math.PI),M=f.lng*180/(L/a*Math.cos(A)*Math.PI);return new y(s,M)}function P(l,r){if(W(l,r))return new y(l,r);const d=F(l,r);return new y(l+d.lat,r+d.lng)}const z={class:"map-container"},G=C({__name:"MonitorMap",setup(l){const r=O(),d=b(null);let f=null;const A=b([]);let e=null;const a={url:r.mqtturl,options:{clean:!0,connectTimeout:4e3,clientId:r.mqttclientid+Math.random().toString(16).substr(2,8)+"map",username:r.mqttuser,password:r.mqttpwd},topic:r.mqtttopic},s=(p,n)=>{const t=JSON.parse(n.toString()),o=t.id,i=t.sensors;return{id:o,lng:i[0].data.value[0],lat:i[0].data.value[1]}},M=(p,n,t,o)=>{const i=["#1890ff","#52c41a","#fadb14","#ff4d4f","#722ed1"],u=i[n%i.length],v=new p.Polyline({path:[[t,o]],strokeColor:u,strokeWeight:3,lineJoin:"round"}),h=new p.Marker({position:[t,o],content:`
      <div class="device-marker" style="background: ${u}">
        ${n}
      </div>`,offset:new p.Pixel(-12,-12)});return f.add([v,h]),{id:n,path:[[t,o]],polyline:v,marker:h}},g=(p,n)=>{let t=A.value.find(o=>o.id===n.id);if(t){const{lat:o,lng:i}=P(n.lat,n.lng),u=[...t.path,[i,o]];t.path=u,t.polyline.setPath(u),t.marker.setPosition([i,o])}else{const{lat:o,lng:i}=P(n.lat,n.lng);t=M(p,n.id,i,o),A.value.push(t)}};return x(async()=>{window._AMapSecurityConfig={securityJsCode:r.securityJsCode},T.load({key:r.key,version:"2.0",plugins:["AMap.Polyline","AMap.Marker"]}).then(p=>{f=new p.Map(d.value,{viewMode:"3D",mapStyle:"amap://styles/normal",zoom:17,center:[121.891751,30.902079]}),e=J.connect(a.url,a.options),e.on("connect",()=>{e.subscribe(a.topic)}),e.on("message",(n,t)=>{const o=s(n,t);g(p,o)})}).catch(console.error)}),q(()=>{e&&(e.unsubscribe(a.topic),e.end(!0),e=null),A.value.forEach(p=>{var n,t;try{f&&!f.isDestroyed()&&f.remove([p.polyline,p.marker]),(n=p.polyline)==null||n.destroy(),(t=p.marker)==null||t.destroy()}catch(o){console.warn("Cleanup error:",o)}finally{p.polyline=null,p.marker=null}}),A.value=[];try{f&&!f.isDestroyed()&&(f.destroy(),f=null)}catch(p){console.warn("Map destroy error:",p)}}),(p,n)=>(D(),j("div",z,[S("div",{ref_key:"mapRef",ref:d,style:{width:"100%",height:"100%"}},null,512)]))}}),H=E(G,[["__scopeId","data-v-1114de6d"]]);export{H as M};
